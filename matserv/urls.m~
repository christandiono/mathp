function [localpath, newurlpath, status]=urls(urlpath)

import settings

question=findstr(urlpath,'?');
if question
    getvars=urlpath(question+1:end);
    urlpath=urlpath(1:question-1);
end

localpath=[settings.HTML_ROOT_DIR urlpath];


%% Prevent '..' from going to a directory higher than HTML_ROOT_DIR
% Compares the paths

currentdir=cd(urlpath);



if ~strncmp(settings.HTML_ROOT_DIR, pwd, length(settings.HTML_ROOT_DIR))
    localpath=settings.ERROR_403;
    newurlpath=urlpath;
    code=403;
    cd(currentdir)
    return
end

cd(currentdir)

%% Redirect http://example.com/foo to http://example.com/foo/

if settings.REDIR_NOSLASH && urlpath(end)~='/' && ~exist(localpath,'file') && exist(localpath,'dir')
    newurlpath=[urlpath '/'];   
    localpath=[localpath '/'];
    status=['HTTP/1.1 301 Moved Permanently' 13 10 'Location: ' newurlpath];
    return
end

%% Display http://example.com/index.html if http://example.com/ requested

if ~exist(localpath,'file') && exist([localpath 'index.html'], 'file')
    localpath=[localpath 'index.html'];
    newurlpath=urlpath;
    status='HTTP/1.1 200 OK';
    return
end

%% Get the file otherwise

if exist(localpath,'file')
    newurlpath=urlpath;
    status='HTTP/1.1 200 OK'
else
    newurlpath=urlpath;
    status='HTTP/1.1 400 Not Found'
end